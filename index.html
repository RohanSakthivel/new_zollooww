<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Product Finder</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f9f9f9;
        }

        header {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            text-align: center;
        }

        main {
            margin-top: 20px;
        }

        .warehouse-section {
            border: 1px solid #007bff;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            background-color: white;
        }

        .product-card {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            background-color: #f0f0f0;
        }

        .product-name {
            font-weight: bold;
        }

        .add-to-cart-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
        }

        .add-to-cart-btn:hover {
            background-color: #218838;
        }

        .cart-item {
            border: 1px solid #007bff;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            background-color: white;
        }

        .remove-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 5px;
        }

        .remove-btn:hover {
            background-color: #c82333;
        }

        footer {
            text-align: center;
            margin-top: 20px;
            color: #555;
        }
    </style>
</head>
<body>
    <header>
        <h1>Warehouse Product Finder</h1>
    </header>
    <main>
        <div id="warehouse-container"></div>
        <h2>Cart</h2>
        <div id="cart-items"></div>
        <button id="place-order-btn">Place Order</button>
    </main>
    <footer>
        <p>&copy; 2024 Your Company</p>
    </footer>
    <script type="module">
        // Import Firebase libraries
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase configuration for displaying products
        const firebaseConfigProducts = {
            apiKey: "AIzaSyCAZvPR5SJ-GGfX8A4PZHZN8uQnu1SPBrI",
            authDomain: "zoloww-2603e.firebaseapp.com",
            projectId: "zoloww-2603e",
            storageBucket: "zoloww-2603e.appspot.com",
            messagingSenderId: "160528827172",
            appId: "1:160528827172:web:07a67d55c46162ab3ea9b1",
            measurementId: "G-HZDMTV126S"
        };

        // Firebase configuration for order placement
        const firebaseConfigOrders = {
            apiKey: "AIzaSyD4_h-2b2_IjrfvSKOxHrL9gWotG-SanFo",
            authDomain: "zolowworder.firebaseapp.com",
            projectId: "zolowworder",
            storageBucket: "zolowworder.appspot.com",
            messagingSenderId: "996982358637",
            appId: "1:996982358637:web:1adcf03392a68d5c6f3564",
            measurementId: "G-4L2GTKRRMF"
        };

        // Initialize Firebase apps
        const appProducts = initializeApp(firebaseConfigProducts, "products");
        const appOrders = initializeApp(firebaseConfigOrders, "orders");

        // Initialize Firestore instances
        const dbProducts = getFirestore(appProducts);
        const dbOrders = getFirestore(appOrders);

        let cart = [];

        // Function to calculate the distance between two coordinates
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const warehouseContainer = document.getElementById('warehouse-container');
            const cartContainer = document.getElementById('cart-items');
            const placeOrderBtn = document.getElementById('place-order-btn');
            const loadingMessage = document.createElement('div');

            loadingMessage.textContent = 'Loading products...';
            warehouseContainer.appendChild(loadingMessage);

            // Get user location using Geolocation API
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const userLatitude = position.coords.latitude;
                    const userLongitude = position.coords.longitude;

                    try {
                        // Fetch warehouse data from Firestore for products
                        const warehousesSnapshot = await getDocs(collection(dbProducts, 'warehouses'));
                        loadingMessage.remove(); // Remove loading message after data is fetched

                        // Loop through each warehouse
                        warehousesSnapshot.forEach(doc => {
                            const data = doc.data();
                            const warehouseName = data.warehouseName;
                            const latitude = data.latitude;
                            const longitude = data.longitude;
                            const products = data.products;

                            // Calculate distance to the warehouse
                            const distance = calculateDistance(userLatitude, userLongitude, latitude, longitude);

                            // Only show warehouses within 4 km
                            if (distance <= 4) {
                                const warehouseSection = document.createElement('div');
                                warehouseSection.className = 'warehouse-section';

                                const warehouseTitle = document.createElement('div');
                                warehouseTitle.className = 'warehouse-title';
                                warehouseTitle.textContent = `Warehouse: ${warehouseName} (Lat: ${latitude}, Long: ${longitude}, Distance: ${distance.toFixed(2)} km)`;

                                warehouseSection.appendChild(warehouseTitle);

                                // Loop through each product in the warehouse
                                for (let product in products) {
                                    const productData = products[product];

                                    const productCard = document.createElement('div');
                                    productCard.className = 'product-card';

                                    productCard.innerHTML = `
                                        <div class="product-name">${product}</div>
                                        <div class="product-details">Package Type: ${productData.packageType}</div>
                                        <div class="product-details">Quantity: ${productData.quantity}</div>
                                        <div class="product-details">Price: â‚¹${productData.price}</div>
                                        <button class="add-to-cart-btn">Add to Cart</button>
                                    `;

                                    const addToCartBtn = productCard.querySelector('.add-to-cart-btn');
                                    addToCartBtn.addEventListener('click', () => {
                                        addToCart({
                                            warehouseName,
                                            product,
                                            packageType: productData.packageType,
                                            quantity: productData.quantity,
                                            price: productData.price
                                        });
                                    });

                                    warehouseSection.appendChild(productCard);
                                }

                                warehouseContainer.appendChild(warehouseSection);
                            }
                        });
                    } catch (error) {
                        console.error("Error fetching warehouses: ", error);
                        alert("Failed to load products. Please try again later.");
                    }
                }, (error) => {
                    console.error("Error getting location: ", error);
                    alert("Unable to retrieve your location. Please check your browser settings.");
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }

            function addToCart(product) {
                cart.push(product);
                displayCart();
            }

            function displayCart() {
                cartContainer.innerHTML = '';
                cart.forEach((item, index) => {
                    const cartItem = document.createElement('div');
                    cartItem.className = 'cart-item';
                    cartItem.innerHTML = `
                        <div>${item.product} (${item.packageType}, â‚¹${item.price}) from ${item.warehouseName}</div>
                        <button class="remove-btn" data-index="${index}">Remove</button>
                    `;
                    cartContainer.appendChild(cartItem);
                });

                // Add event listeners for remove buttons
                const removeButtons = cartContainer.querySelectorAll('.remove-btn');
                removeButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const index = btn.getAttribute('data-index');
                        cart.splice(index, 1);
                        displayCart();
                    });
                });
            }

            placeOrderBtn.addEventListener('click', async () => {
                if (cart.length === 0) {
                    alert("Your cart is empty!");
                    return;
                }

                try {
                    // Place order in Firestore
                    await addDoc(collection(dbOrders, 'orders'), { items: cart, timestamp: new Date() });
                    alert("Order placed successfully!");
                    cart = []; // Clear cart after order
                    displayCart();
                } catch (error) {
                    console.error("Error placing order: ", error);
                    alert("Failed to place order. Please try again later.");
                }
            });
        });
    </script>
</body>
</html>
